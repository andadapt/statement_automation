{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Running URL Check</h1>
    <p id="status">Starting background task...</p>

    <div id="report" style="display:none; margin-top: 20px;">
        <h3>URL Check Report</h3>
        <ul>
            <li>âœ… Working: <span id="working-count"></span></li>
            <li>âŒ Broken: <span id="broken-count"></span></li>
            <li>âš ï¸ Missing: <span id="missing-count"></span></li>
            <li>ğŸ”’ Authentication Required: <span id="auth-count"></span></li>
            <li>ğŸ“¦ Total Checked: <span id="total-count"></span></li>
        </ul>
        <p><a href="{% url 'index' %}">â† Return to Home</a></p>
    </div>
</div>

<script>
    // Start the URL check when page loads
    fetch("{% url 'compliance:run_url_check' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('status').innerText = data.status;
        checkReport();
    });

    // Poll the server for the result every 2 seconds
    function checkReport() {
        fetch("{% url 'compliance:url_check_report' %}")
            .then(response => response.json())
            .then(data => {
                if (data.done) {
                    const report = data.report;
                    document.getElementById('status').innerText = "âœ… URL Check Complete!";
                    document.getElementById('report').style.display = 'block';
                    document.getElementById('working-count').innerText = report.working;
                    document.getElementById('broken-count').innerText = report.broken;
                    document.getElementById('missing-count').innerText = report.missing;
                    document.getElementById('auth-count').innerText = report.authentication;
                    document.getElementById('total-count').innerText = report.total;
                } else {
                    setTimeout(checkReport, 2000);  // Keep polling
                }
            })
            .catch(error => {
                console.error("Error fetching report:", error);
                document.getElementById('status').innerText = "âš ï¸ An error occurred while checking the report.";
            });
    }
</script>
{% endblock %}
